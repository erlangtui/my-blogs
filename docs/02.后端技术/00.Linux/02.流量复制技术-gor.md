---
title: 流量复制技术-gor
date: 2024-08-18 16:57:50
permalink: /pages/38ba49/
categories:
  - 后端技术
  - Linux
tags:
  - 流量复制
author: 
  name: erlangtui
  link: https://github.com/erlangtui
---

## 一、简单介绍
* Gor 是一个开源工具，用于捕获实时 **HTTP** 流量并将其回放到测试环境中，以便使用真实数据持续测试系统的可靠性与稳定性，可以提高开发人员对代码部署、配置更改和基础结构更改的信心。
* Gor 架构试图遵循 UNIX 哲学：一切都由管道组成，各种输入将数据多路复用到输出。
* 用户可以对请求进行速率限制、过滤、重写，甚至可以使用自己的中间件来实现自定义逻辑，还可以以更高的速率重播请求以进行负载测试。

## 二、基本用法
* 用法：gor 输入选项 输出选项

### 1，基础选项
```sh
# 指定单个请求的缓冲区大小，默认 5 MB
--copy-buffer-size value

# 指定 CPU 采样数据的写入文件
--cpuprofile string

# 指定多长时间后退出
--exit-after duration

# 设置详细级别，大于 0 时打开 debug 输出模式
-verbose int
```

### 2，头部选项
#### 2.1 正向过滤
```sh
# 以正则表达式限定请求体的头部，未匹配上的请求将会被丢弃
# eg：gor --input-raw :8080 --output-http staging.com --http-allow-header api-version:^v1
--http-allow-header value

# 限定允许的请求方法，未匹配上的请求将会被丢弃
# eg：gor --input-raw :8080 --output-http staging.com --http-allow-method GET
--http-allow-method value

# 以正则表达式限定请求的url，未匹配上的请求将会被丢弃
# eg：gor --input-raw :8080 --output-http staging.com --http-allow-url ^www.
--http-allow-url value

# 以正则表达式限定解码之后的基本认证信息，未匹配上的请求将会被丢弃
# gor --input-raw :8080 --output-http staging.com --http-basic-auth-filter "^customer[0-9].*"
--http-basic-auth-filter value

# 接收请求的一小部分，根据特定报头的FNV32-1A哈希一致接受或拒绝请求:
# gor --input-raw :8080 --output-http staging.com --http-header-limiter user-id:25%
--http-header-limiter value

# 通常，gor用 --output-http 提供的主机替换主机http报头，此选项禁用该行为，保留原始主机头。
--http-original-host
    	
# 接收一小部分请求，根据特定GET参数的FNV32-1A散列一致地接受或拒绝请求
# eg：gor --input-raw :8080 --output-http staging.com --http-param-limiter user_id:25%
--http-param-limiter value
```
#### 2.2 反向过滤
```sh
# 以正则表达式限定不允许的请求体的头部，匹配上的请求将会被丢弃
# eg：gor --input-raw :8080 --output-http staging.com --http-disallow-header "User-Agent: Replayed by Gor"		 
--http-disallow-header value
    	
# 以正则表达式限定不允许的请求的url，匹配上的请求将会被丢弃
# eg：gor --input-raw :8080 --output-http staging.com --http-disallow-url ^www.
--http-disallow-url value
```
#### 2.3 修改选项
```sh
# 基于映射关系重写请求头部，逗号隔开
# eg：gor --input-raw :8080 --output-http staging.com --http-rewrite-header Host: (.*).example.com,$1.beta.example.com
--http-rewrite-header value

# 基于映射关系重写请求URL，分号隔开
# eg：gor --input-raw :8080 --output-http staging.com --http-rewrite-url /v1/user/([^\/]+)/ping:/v2/user/$1/ping
--http-rewrite-url value
    		
# 向请求中注入额外的头部字段值
# eg：gor --input-raw :8080 --output-http staging.com --http-set-header 'User-Agent: Gor'
--http-set-header value
    		
# 设置请求参数，如果已存在则覆盖
# eg：gor --input-raw :8080 --output-http staging.com --http-set-param api_key=1
--http-set-param value
```
#### 2.4 其他
```sh  	
# 指定端口开启采样，暴露路径 /debug/pprof
--http-pprof :8181
```

### 3，输入选项
#### 3.1 文件输入
```sh

# 从文件中读取请求，可能是以前录制的文件
# eg：gor --input-file ./requests.gor --output-http staging.com
--input-file value

# 模拟从数据源读取数据，但不重播，将获得有关预期重放时间，发现记录的数量等信息。
--input-file-dry-run

# 循环从文件中读取，用于性能测试
--input-file-loop

# 设置请求之间的最大时间间隔，当请求间隔时间过长，可以跳过该次请求
--input-file-max-wait duration

# 尝试提前读取和缓存多个记录，与此同时，如果它们无序的话它还执行请求排序。由于它需要在内存中保存这个缓冲区，较大的值可能会导致性能变差(默认值为100)。
--input-file-read-depth int
```
#### 3.2 原始输入
```sh

--input-raw value
Capture traffic from given port (use RAW sockets and require *sudo* access):
# Capture traffic from 8080 port
gor --input-raw :8080 --output-http staging.com
--input-raw-allow-incomplete
If turned on Gor will record HTTP messages with missing packets
--input-raw-bpf-filter string
BPF filter to write custom expressions. Can be useful in case of non standard network interfaces like tunneling or SPAN port. Example: --input-raw-bpf-filter 'dst port 80'
--input-raw-buffer-size value
Controls size of the OS buffer which holds packets until they dispatched. Default value depends by system: in Linux around 2MB. If you see big package drop, increase this value.
--input-raw-buffer-timeout duration
set the pcap timeout. for immediate mode don't set this flag
--input-raw-engine libpcap
Intercept traffic using libpcap (default), `raw_socket` or `pcap_file`
--input-raw-expire duration
How much it should wait for the last TCP packet, till consider that TCP message complete. (default 2s)
--input-raw-monitor
enable RF monitor mode
--input-raw-override-snaplen
Override the capture snaplen to be 64k. Required for some Virtualized environments
--input-raw-promisc
enable promiscuous mode
--input-raw-protocol value
Specify application protocol of intercepted traffic. Possible values: http, binary
--input-raw-realip-header string
If not blank, injects header with given name and real IP value to the request payload. Usually this header should be named: X-Real-IP
--input-raw-stats
enable stats generator on raw TCP messages
--input-raw-timestamp-type string
Possible values: PCAP_TSTAMP_HOST, PCAP_TSTAMP_HOST_LOWPREC, PCAP_TSTAMP_HOST_HIPREC, PCAP_TSTAMP_ADAPTER, PCAP_TSTAMP_ADAPTER_UNSYNCED. This values not supported on all systems, GoReplay will tell you available values of you put wrong one.
--input-raw-track-response
If turned on Gor will track responses in addition to requests, and they will be available to middleware and file output.
```

#### 3.3 Kafka 相关
```sh
# 将请求和返回的状态发送到 Kafka 
# eg：gor --output-stdout --input-kafka-host '192.168.0.1:9092,192.168.0.2:9092'
--input-kafka-host string
--input-kafka-json-format
If turned on, it will assume that messages coming in JSON format rather than  GoReplay text format.
--input-kafka-topic string
Send request and response stats to Kafka:
gor --output-stdout --input-kafka-topic 'kafka-log'
```
#### 3.4 其他
--input-raw- 用于捕获 HTTP 流量，您应指定 IP 地址或接口和应用程序端口。详细了解捕获和回放流量。
--input-file- 接受以前使用 录制的文件。有关从文件保存和重放的更多信息--output-file
--input-tcp- 如果您决定将来自多个转发器 Gor 实例的流量转发到它，则由 Gor 聚合实例使用。阅读有关使用聚合器转发器设置的信息。
```sh
# 用于测试输出，每秒发出一次 'Get /' 请求
--input-dummy value

--input-tcp value
Used for internal communication between Gor instances. Example:
# Receive requests from other Gor instances on 28020 port, and redirect output to staging
gor --input-tcp :28020 --output-http staging.com
--input-tcp-certificate string
Path to PEM encoded certificate file. Used when TLS turned on.
--input-tcp-certificate-key string
Path to PEM encoded certificate key file. Used when TLS turned on.
--input-tcp-secure
Turn on TLS security. Do not forget to specify certificate and key files.
```
可用输出：
### 4，输出选项

--output-http- 将 HTTP 流量重放到给定端点，接受基本 URL。阅读更多关于它的信息
--output-file- 记录对文件的传入流量。有关从文件保存和重放的更多信息
--output-tcp- 将传入的数据转发到另一个 Gor 实例，与 一起使用。阅读有关聚合器-转发器设置的更多信息。--input-tcp
--output-stdout- 用于调试，将所有数据输出到 stdout。
```sh
-kafka-tls-ca-cert string
CA certificate for Kafka TLS Config:
gor  --input-raw :3000 --output-kafka-host '192.168.0.1:9092' --output-kafka-topic 'topic' --kafka-tls-ca-cert cacert.cer.pem --kafka-tls-client-cert client.cer.pem --kafka-tls-client-key client.key.pem
-kafka-tls-client-cert string
Client certificate for Kafka TLS Config (mandatory with to kafka-tls-ca-cert and kafka-tls-client-key)
-kafka-tls-client-key string
Client Key for Kafka TLS Config (mandatory with to kafka-tls-client-cert and kafka-tls-client-key)
-memprofile string
write memory profile to this file
-middleware string
Used for modifying traffic using external command
-output-binary value
Forwards incoming binary payloads to given address.
# Redirect all incoming requests to staging.com address
gor --input-raw :80 --input-raw-protocol binary --output-binary staging.com:80
-output-binary-debug
Enables binary debug output.
-output-binary-timeout duration
Specify HTTP request/response timeout. By default 5s. Example: --output-binary-timeout 30s
-output-binary-track-response
If turned on, Binary output responses will be set to all outputs like stdout, file and etc.
-output-binary-workers int
Gor uses dynamic worker scaling by default.  Enter a number to run a set number of workers.
-output-file value
Write incoming requests to file:
gor --input-raw :80 --output-file ./requests.gor
-output-file-append
The flushed chunk is appended to existence file or not.
-output-file-buffer string
The path for temporary storing current buffer:
gor --input-raw :80 --output-file s3://mybucket/logs/%Y-%m-%d.gz --output-file-buffer /mnt/logs (default "/tmp")
-output-file-flush-interval duration
Interval for forcing buffer flush to the file, default: 1s. (default 1s)
-output-file-max-size-limit value
Max size of output file, Default: 1TB
-output-file-queue-limit int
The length of the chunk queue. Default: 256 (default 256)
-output-file-size-limit value
Size of each chunk. Default: 32mb
-output-http value
Forwards incoming requests to given http address.
# Redirect all incoming requests to staging.com address
gor --input-raw :80 --output-http http://staging.com
-output-http-elasticsearch string
Send request and response stats to ElasticSearch:
gor --input-raw :8080 --output-http staging.com --output-http-elasticsearch 'es_host:api_port/index_name'
-output-http-queue-len int
Number of requests that can be queued for output, if all workers are busy. default = 1000 (default 1000)
-output-http-redirects int
Enable how often redirects should be followed.
-output-http-response-buffer value
HTTP response buffer size, all data after this size will be discarded.
-output-http-skip-verify
Don't verify hostname on TLS secure connection.
-output-http-stats
Report http output queue stats to console every N milliseconds. See output-http-stats-ms
-output-http-stats-ms int
Report http output queue stats to console every N milliseconds. default: 5000 (default 5000)
-output-http-timeout duration
Specify HTTP request/response timeout. By default 5s. Example: --output-http-timeout 30s (default 5s)
-output-http-track-response
If turned on, HTTP output responses will be set to all outputs like stdout, file and etc.
-output-http-worker-timeout duration
Duration to rollback idle workers. (default 2s)
-output-http-workers int
Gor uses dynamic worker scaling. Enter a number to set a maximum number of workers. default = 0 = unlimited.
-output-http-workers-min int
Gor uses dynamic worker scaling. Enter a number to set a minimum number of workers. default = 1.
-output-kafka-host string
Read request and response stats from Kafka:
gor --input-raw :8080 --output-kafka-host '192.168.0.1:9092,192.168.0.2:9092'
-output-kafka-json-format
If turned on, it will serialize messages from GoReplay text format to JSON.
-output-kafka-topic string
Read request and response stats from Kafka:
gor --input-raw :8080 --output-kafka-topic 'kafka-log'
-output-null
Used for testing inputs. Drops all requests.
-output-stdout
Used for testing inputs. Just prints to console data coming from inputs.
-output-tcp value
Used for internal communication between Gor instances. Example:
# Listen for requests on 80 port and forward them to other Gor instance on 28020 port
gor --input-raw :80 --output-tcp replay.local:28020
-output-tcp-response-buffer value
TCP response buffer size, all data after this size will be discarded.
-output-tcp-secure
Use TLS secure connection. --input-file on another end should have TLS turned on as well.
-output-tcp-skip-verify
Don't verify hostname on TLS secure connection.
-output-tcp-stats
Report TCP output queue stats to console every 5 seconds.
-output-tcp-sticky
Use Sticky connection. Request/Response with same ID will be sent to the same connection.
-output-tcp-workers int
Number of parallel tcp connections, default is 10 (default 10)
-prettify-http
If enabled, will automatically decode requests and responses with: Content-Encoding: gzip and Transfer-Encoding: chunked. Useful for debugging, in conjunction with --output-stdout

-recognize-tcp-sessions
[PRO] If turned on http output will create separate worker for each TCP session. Splitting output will session based as well.
-split-output true
By default each output gets same traffic. If set to true it splits traffic equally among all outputs.
-stats
Turn on queue stats output
```