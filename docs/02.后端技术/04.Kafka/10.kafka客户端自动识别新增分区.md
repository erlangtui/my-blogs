---
title: kafka客户端自动识别新增分区
date: 2024-08-06 23:06:24
permalink: /pages/fd37b0/
categories:
  - 后端技术
  - Kafka
  - Go
tags:
  - Kafka
  - Go
author: 
  name: erlangtui
  link: https://github.com/erlangtui
---

## 一、背景

广告曝光日志会通过 filebeat 写入 Kafka，下游服务消费 Kafka 获取日志信息并进行后续处理。由于最近巴黎奥运会热点事件频发，经常短时间内流量急剧暴涨，Kafka集群中心部分机器达到性能瓶颈，导致这些机器上的分区出现了消费堆积（写入也有问题），影响下游服务，Kafka 同学通过扩展对应 topic 的分区数量解决该问题。

Kafka 客户端消费服务是基于 go 语言编写的，使用的是 sarama-cluster 库，当分区数量增加时，没有自动识别出来，此时如果没有手动重启客户端触发 rebalance，则无法消费到新的分区导致消息丢失，影响后续业务。

另外，即使能够自动识别新分区触发 rebalance，如果客户端的消费起始位移配置的是从最新处开始消费，当客户端 rebalance 完毕开始从新分区消费消息时，是从分区的最新处开始消费，客户端无法消费在新分区开始接收消息到客户端开始从新分区消费消息这段时间内的消息，导致消息丢失。

## 二、go 常用的 Kafka 库

## 三、sarama 

## 四、sarama-cluster

## 五、kafka-go

## 六、confluent-kafka-go

## 七、总结

kafka 的 go 客户端常用的几个库分别是 sarama、sarama-cluster、kafka-go、confluent-kafka-go。
