(window.webpackJsonp=window.webpackJsonp||[]).push([[38],{366:function(t,s,a){"use strict";a.r(s);var e=a(4),r=Object(e.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("blockquote",[s("p",[t._v("TCPCopy 是一个 TCP 流转发工具，支持互联网服务器应用程序的实际测试\n")])]),t._v(" "),s("h2",{attrs:{id:"一、简介"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#一、简介"}},[t._v("#")]),t._v(" 一、简介")]),t._v(" "),s("ul",[s("li",[t._v("背景：线上流量过于复杂，难以模拟出真实的请求对线上服务进行测试；")]),t._v(" "),s("li",[t._v("TCPCopy 作为一个实时流重放工具，能够生成类似于生产环境的流量；")]),t._v(" "),s("li",[t._v("TCPCopy 是"),s("span",{staticStyle:{color:"red"}},[s("strong",[t._v("对 tcp 包进行转发，与应用层协议无关")])]),t._v("，mysql、redis、http等都可以转发；")]),t._v(" "),s("li",[t._v("TCPCopy 除了"),s("span",{staticStyle:{color:"red"}},[s("strong",[t._v("占用额外的 CPU、内存和带宽外")])]),t._v("，对生产系统几乎没有影响；")]),t._v(" "),s("li",[t._v("复制工作负载在请求多样性、网络延迟和资源占用方面与生产工作负载相似。")])]),t._v(" "),s("h2",{attrs:{id:"二、应用场景"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#二、应用场景"}},[t._v("#")]),t._v(" 二、应用场景")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("分布式压力测试")]),t._v("：\n"),s("ul",[s("li",[t._v("使用 TCPCopy 复制真实数据，对服务器软件进行压力测试，可以找到只能在高压力情况下产生的错误；")])])]),t._v(" "),s("li",[s("strong",[t._v("稳定性测试")]),t._v("：\n"),s("ul",[s("li",[t._v("证明新系统是稳定的，并找到只发生在生产环境中的错误；")])])]),t._v(" "),s("li",[s("strong",[t._v("回归测试")]),t._v("：\n"),s("ul",[s("li",[t._v("利用 TCPCopy 复制生产流量，复现bug问题；")])])]),t._v(" "),s("li",[s("strong",[t._v("性能比较")]),t._v("：\n"),s("ul",[s("li",[t._v("利用 TCPCopy 复制或放大生产流量，验证新版本性能是否达标；")])])])]),t._v(" "),s("h2",{attrs:{id:"三、架构设计"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#三、架构设计"}},[t._v("#")]),t._v(" 三、架构设计")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://jsd.cdn.zzko.cn/gh/erlangtui/img-bed@master/linux/tcpcopy.6s7v8j0j4fpc.jpg",alt:"架构图"}})]),t._v(" "),s("ul",[s("li",[t._v("TCPCOPY 默认使用"),s("strong",[t._v("原始套接字输入技术")]),t._v("在"),s("span",{staticStyle:{color:"red"}},[s("strong",[t._v("网络层")])]),t._v("捕获在线数据包并进行必要的处理（包括TCP交互模拟、网络延迟控制和常见的上层交互模拟），并默认使用"),s("strong",[t._v("原始套接字输出技术")]),t._v("将数据包发送到目标服务器（图中用粉红色箭头表示）；")]),t._v(" "),s("li",[t._v("TCPCopy 由两部分组成：tcpcopy 和 intercept；\n"),s("ul",[s("li",[t._v("tcpcopy 运行在"),s("span",{staticStyle:{color:"red"}},[s("strong",[t._v("线上")])]),t._v("服务器，对真实请求的 tcp 包进行复制并转发到"),s("span",{staticStyle:{color:"red"}},[s("strong",[t._v("目标")])]),t._v("服务器上；")]),t._v(" "),s("li",[t._v("intercept 运行在"),s("span",{staticStyle:{color:"red"}},[s("strong",[t._v("辅助")])]),t._v("服务器上，执行一些辅助工作，例如将目标服务器的响应信息传递给 tcpcopy；")]),t._v(" "),s("li",[t._v("intercept 将提取响应标头信息，并使用特殊通道将响应标头发送到 tcpcopy（图中紫色箭头所示）；")]),t._v(" "),s("li",[t._v("tcpcopy 收到响应标头时，它会利用标头信息修改联机数据包的属性，并继续发送另一个数据包；")])])]),t._v(" "),s("li",[t._v("目标服务器上唯一需要的操作是设置适当的"),s("span",{staticStyle:{color:"red"}},[s("strong",[t._v("路由")])]),t._v("命令，以将响应数据包（图中的绿色箭头所示）路由到"),s("span",{staticStyle:{color:"red"}},[s("strong",[t._v("辅助")])]),t._v("服务器；")]),t._v(" "),s("li",[t._v("应该注意的是，来自目标服务器的响应被路由到辅助服务器，该服务器应该充当"),s("strong",[t._v("黑洞")]),t._v("；")])]),t._v(" "),s("h2",{attrs:{id:"四、安装与说明"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#四、安装与说明"}},[t._v("#")]),t._v(" 四、安装与说明")]),t._v(" "),s("h3",{attrs:{id:"_1-线上机器上安装-tcpcopy"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-线上机器上安装-tcpcopy"}},[t._v("#")]),t._v(" 1，线上机器上安装 tcpcopy")]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v(" https://github.com/session-replay-tools/tcpcopy/archive/1.0.0.tar.gz\n "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tar")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-zxf")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.0")]),t._v(".0.tar.gz\n "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" tcpcopy-1.0.0\n ./configure "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--prefix")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/opt/tcpcopy/ "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 默认安装目录 /usr/local/tcpcopy")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br")])]),s("h3",{attrs:{id:"_2-tcpcopy-常用选项"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-tcpcopy-常用选项"}},[t._v("#")]),t._v(" 2，tcpcopy 常用选项")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("选项")]),t._v(" "),s("th",[t._v("含义")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[s("code",[t._v("-x <transfer,>")])]),t._v(" "),s("td",[s("span",{staticStyle:{color:"red"}},[s("strong",[t._v("指定源服务器和目标服务器的ip和端口")])]),t._v("，"),s("code",[t._v("<transfer，>")]),t._v("的格式可以为："),s("code",[t._v("sourceIP:sourcePort-targetIP:targetPort，…")]),t._v("，大多数情况下，sourceIP可以省略，两个'transfer'由'，'(逗号)分隔")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("-H <ip_addr>")])]),t._v(" "),s("td",[t._v("将本地主机的IP地址更改为给定的IP地址")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("-c <ip_addr,>")])]),t._v(" "),s("td",[s("span",{staticStyle:{color:"red"}},[s("strong",[t._v("发送到目标服务器时")])]),t._v("，将客户端IP地址更改为IP地址之一")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("-n <num>")])]),t._v(" "),s("td",[s("span",{staticStyle:{color:"red"}},[s("strong",[t._v("设置流量复制倍数")])]),t._v("，最大值为 1023。由于多次复制是基于修改端口号进行的，因此可能会出现端口冲突的情况，特别是在内网应用中，源ip很少，连接时间较短。因此复制倍数越小，tcpcopy将执行得更好")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("-f <num>")])]),t._v(" "),s("td",[t._v("当运行多个tcpcopy实例时，使用此参数控制端口号修改进程，减少端口冲突。对于不同的tcpcopy实例，"),s("code",[t._v("<num>")]),t._v(" 的值应该不同，允许的最大值是1023")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("-m <num>")])]),t._v(" "),s("td",[s("span",{staticStyle:{color:"red"}},[s("strong",[t._v("设置tcpcopy允许使用的最大内存(以兆为单位)")])]),t._v("，防止tcpcopy占用过多内存，影响在线系统。当内存超过这个限制时，tcpcopy 将自动退出。该参数仅在内核版本为2.6.32及以上时有效。默认为1024")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("-M <num>")])]),t._v(" "),s("td",[t._v("MTU，最大传输单元，数据链路层能够传输的最大网络包大小，默认 1500)")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("-D <num>")])]),t._v(" "),s("td",[t._v("MSS，最大分段尺寸，网络包能够装下最大报文大小，默认 1460")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("-R <num>")])]),t._v(" "),s("td",[t._v("设置默认的 rtt 值")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("-U <num>")])]),t._v(" "),s("td",[t._v("设置用户会话池大小，单位为千字节，默认为 1，最大 63")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("-C <num>")])]),t._v(" "),s("td",[t._v("tcpcopy 与 intercept 之间的并发连接数，默认为 2，最大值为 11")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("-s <server,>")])]),t._v(" "),s("td",[s("span",{staticStyle:{color:"red"}},[s("strong",[t._v("intercept 服务列表")])]),t._v("，形如：ip_addr1:port1, ip_addr2:port2, ...")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("-t <num>")])]),t._v(" "),s("td",[t._v("设置会话的超时时间。在超时时间后 tcpcopy 还没收到目标服务器的返回，该会话将被丢弃。当来自目标服务器的响应较慢或应用程序协议基于上下文时，应该设置更大的值。默认值 120 seconds.")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("-k <num>")])]),t._v(" "),s("td",[t._v("设置会话保持的超时时间")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("-l <file>")])]),t._v(" "),s("td",[t._v("设置日志文件")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("-r <num>")])]),t._v(" "),s("td",[t._v("设置会话传输百分比 (integer range:1~100)")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("-p <num>")])]),t._v(" "),s("td",[t._v("设置目标服务器的监听端口，默认值 36524.")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("-P <file>")])]),t._v(" "),s("td",[t._v("设置 pid 存储的文件，仅用于 -d 选项下")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("-O")])]),t._v(" "),s("td",[t._v("仅回放全会话")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("-g")])]),t._v(" "),s("td",[t._v("慢慢回放 gradully")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("-v")])]),t._v(" "),s("td",[t._v("版本")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("-h")])]),t._v(" "),s("td",[t._v("打印帮助并退出")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("-d")])]),t._v(" "),s("td",[t._v("以守护进程的方式运行")])])])]),t._v(" "),s("h3",{attrs:{id:"_3-辅助机器上安装-intercept"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-辅助机器上安装-intercept"}},[t._v("#")]),t._v(" 3，辅助机器上安装 intercept")]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v(" yum "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-y")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" libpcap-devel "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 在Unix-like系统上捕获网络数据包的库")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v(" https://github.com/session-replay-tools/intercept/archive/1.0.0.tar.gz\n "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tar")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-zxf")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.0")]),t._v(".0.tar.gz\n "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" intercept-1.0.0\n ./configure "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--prefix")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/opt/tcpcopy/\n "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br")])]),s("h3",{attrs:{id:"_4-intercept-常用选项"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-intercept-常用选项"}},[t._v("#")]),t._v(" 4，intercept 常用选项")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("选项")]),t._v(" "),s("th",[t._v("含义")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[s("code",[t._v("-i <device,>")])]),t._v(" "),s("td",[s("span",{staticStyle:{color:"red"}},[s("strong",[t._v("要侦听的网卡接口名称")])]),t._v("，通常是驱动程序名称后面跟着一个单元号，例如，第一个以太网接口为eth0")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("-F <filter>")])]),t._v(" "),s("td",[s("span",{staticStyle:{color:"red"}},[s("strong",[t._v("过滤规则")])]),t._v("(和 pcap 规则一样)")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("-n <num>")])]),t._v(" "),s("td",[t._v("设置最大合并包的数量")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("-p <num>")])]),t._v(" "),s("td",[t._v("设置监听的 TCP 端口号，默认 36524")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("-s <num>")])]),t._v(" "),s("td",[t._v("为 intercept 设置哈希表的尺寸，默认 65536")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("-l <file>")])]),t._v(" "),s("td",[t._v("设置日志文件")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("-P <file>")])]),t._v(" "),s("td",[t._v("设置 pid 存储的文件，仅用于 -d 选项下")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("-b <ip_addr>")])]),t._v(" "),s("td",[t._v("监听接口 (默认 INADDR_ANY, 所有地址)")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("-v")])]),t._v(" "),s("td",[t._v("版本")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("-h")])]),t._v(" "),s("td",[t._v("打印帮助并退出")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("-d")])]),t._v(" "),s("td",[t._v("以守护进程的方式运行")])])])]),t._v(" "),s("h2",{attrs:{id:"五、快速入门"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#五、快速入门"}},[t._v("#")]),t._v(" 五、快速入门")]),t._v(" "),s("ul",[s("li",[t._v("假设 “61.135.233.160” 为目标服务器的 IP 地址；")]),t._v(" "),s("li",[t._v("假设 “61.135.233.161” 为辅助服务器的 IP 地址；")])]),t._v(" "),s("h3",{attrs:{id:"_1-目标服务器设置路由"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-目标服务器设置路由"}},[t._v("#")]),t._v(" 1，目标服务器设置路由")]),t._v(" "),s("ul",[s("li",[t._v("设置适当的路由命令，将目标服务器的响应报文路由到辅助服务器；")])]),t._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 执行 route 命令将所有对 “62.135.200.x” 客户端的响应路由到辅助服务器 “61.135.233.161”")]),t._v("\nroute "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-net")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("62.135")]),t._v(".200.0 netmask "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("255.255")]),t._v(".255.0 gw "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("61.135")]),t._v(".233.161\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br")])]),s("h3",{attrs:{id:"_2-辅助服务器运行-intercept"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-辅助服务器运行-intercept"}},[t._v("#")]),t._v(" 2，辅助服务器运行 intercept")]),t._v(" "),s("ul",[s("li",[t._v("在辅助服务器上运行 intercept，需要 root 权限或CAP_NET_RAW功能；")])]),t._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 监听 eth0 网卡，监听 8080 端口的 tcp 包，以守护进程的方式运行")]),t._v("\n./intercept "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-i")]),t._v(" eth0 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-F")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'tcp and src port 8080'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-d")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br")])]),s("h3",{attrs:{id:"_3-线上服务器运行-tcpcopy"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-线上服务器运行-tcpcopy"}},[t._v("#")]),t._v(" 3，线上服务器运行 tcpcopy")]),t._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# 捕获当前服务器上 “80” 端口数据包，更改客户端IP地址为 “62.135.200.x" 中的一个')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 将这些数据包发送到目标服务器 ”61.135.233.160“ 的 ”8080“")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 连接辅助服务器 “61.135.233.161”，将响应数据包传递给 intercept")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# ”-c" 参数是可选的，设置它是为了简化路由命令')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 流量复制比例为 2 倍")]),t._v("\n./tcpcopy "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-x")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("-61.135.233.160:8080 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-s")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("61.135")]),t._v(".233.161 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-c")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("62.135")]),t._v(".200.x "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-n")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br")])]),s("h2",{attrs:{id:"六、注意事项"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#六、注意事项"}},[t._v("#")]),t._v(" 六、注意事项")]),t._v(" "),s("ul",[s("li",[t._v("仅在 Linux 上测试通过（内核2.6或更高版本）；")]),t._v(" "),s("li",[t._v("TCPCopy 可能会丢失数据包，从而丢失请求；")]),t._v(" "),s("li",[t._v("需要 "),s("code",[t._v("root")]),t._v(" 权限或 "),s("code",[t._v("CAP_NET_RAW")]),t._v(" 功能（例如"),s("code",[t._v("setcap CAP_NET_RAW=ep tcpcopy")]),t._v("）")]),t._v(" "),s("li",[t._v("TCPCopy 现在仅支持客户端启动的连接；")]),t._v(" "),s("li",[t._v("TCPCopy 不支持使用 "),s("code",[t._v("SSL/TLS")]),t._v(" 的服务器应用程序的重放；")]),t._v(" "),s("li",[t._v("有关 MySQL 会话重播，请参阅 https://github.com/session-replay-tools；")]),t._v(" "),s("li",[t._v("不应该辅助服务器上设置 "),s("code",[t._v("ip_forward")]),t._v(" 为 true，否则无法充当黑洞；\n")])]),t._v(" "),s("h2",{attrs:{id:"七、可能存在的问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#七、可能存在的问题"}},[t._v("#")]),t._v(" 七、可能存在的问题")]),t._v(" "),s("h3",{attrs:{id:"_1-捕获接口"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-捕获接口"}},[t._v("#")]),t._v(" 1，捕获接口")]),t._v(" "),s("ul",[s("li",[t._v("默认情况下，TCPcopy 利用原始套接字输入接口在线上服务器上的网络层捕获数据包，系统繁忙时，系统内核可能会丢失一些数据包；")]),t._v(" "),s("li",[t._v("在执行 tcpcopy 的 "),s("code",[t._v("./configure")]),t._v(" 时，如果使用 "),s("code",[t._v("--pcap-capture")]),t._v(" 配置，则 tcpcopy 可以在数据链路层捕获数据包，也可以过滤内核中的数据包；")]),t._v(" "),s("li",[t._v("使用 "),s("code",[t._v("PF_RING")]),t._v("，tcpcopy 在使用 pcap 捕获时会丢失更少的数据包；")]),t._v(" "),s("li",[t._v("捕获请求的最佳方法是通过交换机镜像入口数据包，然后通过负载均衡器将巨大的流量划分到多台机器；")])]),t._v(" "),s("h3",{attrs:{id:"_2-发送接口"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-发送接口"}},[t._v("#")]),t._v(" 2. 发送接口")]),t._v(" "),s("ul",[s("li",[t._v("默认情况下，TCPcopy 利用原始套接字输出接口将网络层的数据包发送到目标服务器；")]),t._v(" "),s("li",[t._v("如果要避免 "),s("code",[t._v("ip_conntrack")]),t._v(" 问题或获得更好的性能，在执行 tcpcopy 的 "),s("code",[t._v("./configure")]),t._v(" 时，如果使用 "),s("code",[t._v("--pcap-send")]),t._v(" 配置，然后使用适当的参数，tcpcopy 可以在数据链路层将数据包发送到目标服务器；")])]),t._v(" "),s("h3",{attrs:{id:"_3-在前往目标服务器的途中"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-在前往目标服务器的途中"}},[t._v("#")]),t._v(" 3，在前往目标服务器的途中")]),t._v(" "),s("ul",[s("li",[t._v("当数据包通过 tcpcopy 发送时，默认情况下，数据包中的源IP地址仍然是终端用户的IP地址，而不是在线服务器的IP地址，某些安全设备可能会将其视为无效或伪造的数据包并将其丢弃；")]),t._v(" "),s("li",[t._v("在这种情况下，使用 tcpdump 捕获目标服务器上的数据包时，不会捕获来自期待的终端用户的数据包；")]),t._v(" "),s("li",[t._v("要了解是否处于这种情况，可以选择同一网段中的目标服务器进行测试，如果数据包可以在同一网段中成功发送到目标服务器，但跨网段未成功发送，则数据包可能会中途丢弃；")]),t._v(" "),s("li",[t._v("为了解决这个问题，"),s("span",{staticStyle:{color:"red"}},[s("strong",[t._v("建议在同一网段的服务器上部署 tcpcopy、intercept 和目标应用程序")])]),t._v("；")]),t._v(" "),s("li",[t._v("在同一网段中的代理的帮助下，TCPcopy 可以将数据包发送到代理，然后代理将相应的请求发送到另一个网段中的目标服务器；")])]),t._v(" "),s("h3",{attrs:{id:"_4-目标服务器的操作系统"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-目标服务器的操作系统"}},[t._v("#")]),t._v(" 4，目标服务器的操作系统")]),t._v(" "),s("ul",[s("li",[t._v("目标服务器如果设置了 "),s("code",[t._v("rpfilter")]),t._v("，将检查数据包中的源 IP 地址是否是伪造的，如果是，数据包将在"),s("span",{staticStyle:{color:"red"}},[s("strong",[t._v("网络层")])]),t._v("丢弃；")]),t._v(" "),s("li",[t._v("如果目标服务器上的 tcpdump 可以捕获数据包，服务却无法收到请求，则应检查是否有任何相应的 "),s("code",[t._v("rpfilter")]),t._v(" 设置，如果设置，则必须删除相关设置，以使数据包通过网络层；")]),t._v(" "),s("li",[t._v("还有其他原因导致 tcpcopy 无法正常工作，例如 iptables 设置问题；")])]),t._v(" "),s("h3",{attrs:{id:"_5-目标服务器上的服务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-目标服务器上的服务"}},[t._v("#")]),t._v(" 5，目标服务器上的服务")]),t._v(" "),s("ul",[s("li",[t._v("目标服务器上的服务可能无法及时处理所有请求；")]),t._v(" "),s("li",[t._v("一方面，服务中的错误可能会使请求长时间没有响应；")]),t._v(" "),s("li",[t._v("另一方面，TCP 层以上的某些协议可能只处理套接字缓冲区中的第一个请求，而将套接字缓冲区中的剩余请求保留为未处理；")])]),t._v(" "),s("blockquote",[s("p",[s("strong",[t._v("参考文章")]),s("br"),t._v("\n[1] "),s("a",{attrs:{href:"https://github.com/session-replay-tools/tcpcopy",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/session-replay-tools/tcpcopy"),s("OutboundLink")],1),s("br"),t._v("\n[2] "),s("a",{attrs:{href:"https://cloud.tencent.com/developer/article/1537496",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://cloud.tencent.com/developer/article/1537496"),s("OutboundLink")],1),s("br")])])])}),[],!1,null,null,null);s.default=r.exports}}]);